<h1>Distributed Network Messaging Protocol</h1>

Коммерческое использование только с разрешения автора.<br>
При использовании необходимо явно указывать ссылку на источник.<br>
<br>
<p>Sergey Bodrov, 2010-10-24</p>

<h1>Канал (групповой чат)</h1>


Канал содержит:<br>
<li>Имя, начинающееся с символа "#" (решетка) и не содержащее пробелов.<br>
<li>Описание (топик), представляющее собой строку символов.<br>
<li>Список владельцев<br>
<li>Список абонентов (подписчиков)<br>
<li>Список последних сообщений<br>
<li>"Черный список" абонентов<br>
<br>
Запись об абоненте содержит:<br>
<li>GUID абонента<br>
<li>состояние (подключен или отключен)<br>
<li>ник (имя на канале, не зависит от реального имени)<br>
<li>адрес<br>
<li>полномочия (набор полномочий)<br>
<li>статус (сообщение абонента)<br>
<li>аватар (картинка)<br>
<br>
Сообщение канала содержит:<br>
<li>дату-время<br>
<li>имя автора<br>
<li>GUID автора<br>
<li>текст сообщения<br>
<br>
Запись "черного списка" содержит:<br>
<li>GUID автора<br>
<li>GUID абонента<br>
<li>текст причины<br>
<li>дату-время окончания<br>
<br>
<p>При подключении или подписке клиента на канал, он получает описание канала, список других подключенных абонентов и список последних сообщений. Если абонент в "черном списке", то подключение не допускается.</p>

<p>При отправке клиентом сообщения на канал, сообщение направляется на узел сервиса. Сервис перенаправляет сообщение всем абонентам канала и добавляет его с список последних сообщений. Если размер списка последних сообщений превышает заданный, то самое раннее сообщение из списка удаляется.</p>

<p>При отключении абонента, его состояние в списке абонентов меняется на "отключен". При этом запись об абоненте не удаляется из списка подписчиков.</p>

<p>Любое новое сообщение или изменение в списке абонентов пересылается всем абонентам. Если абонентом является узел, то другим абонентам этого узла сообщения не передаются, это делает сам узел-подписчик.</p>


<h2>Формат сообщений DNMP</h2>

<u>Обязаительные реквизиты для всех сообщений</u><br>
Тип: <b>GRPC</b><br>
Параметры:<br>
<b>name</b> - название группы (канала)<br>

<u>Сообщение на канал</u><br>
Параметры:<br>
<b>author_name</b> - имя автора сообщения<br>
<b>author_guid</b> - GUID автора сообщения<br>
<b>timestamp</b> - таймштамп сообщения<br>
Данные:<br>
текст сообщения<br>

<u>Команда сервису</u><br>
Параметры:<br>
<b>cmd</b> - команда<br>
Данные:<br>
параметры команды<br>

<u>Данные</u><br>
Параметры:<br>
<b>data</b> - тип данных<br>
Данные:<br>
содержимое данных<br>

<h3>Команды:</h3>
(S) - Cервис на узле<br>
(C) - Клиент<br>
(SС) - Сервис на узле и клиент<br>

<pre><code><br>
JOIN &lt;GUID_абонента&gt; [текст]<br>
(S) Если абонент не в "черном списке", то добавляем абонента в список подписчиков<br>
и пользователей канала. Затем отправляем абоненту информацию о канале (тема,<br>
режимы), список пользователей, последние сообщения.<br>
(C) Добавляет абонента в список подписчиков и пользователей канала.<br>
<br>
LEAVE &lt;GUID_абонента&gt; [текст]<br>
(SС) Убирает абонента из списка подписчиков и пользователей канала.<br>
<br>
SET_TOPIC &lt;текст&gt;<br>
(S) Устанавливает тему канала<br>
<br>
GET_TOPIC<br>
(S) Возвращает сообщение, содержащее заголовок (тему) канала.<br>
<br>
GET_USERS<br>
(S) Возвращает список активных подписчиков<br>
<br>
GET_ABONENTS<br>
(S) Возвращает список всех подписчиков<br>
<br>
GET_LAST_MESSAGES [число сообщений]<br>
(S) Возвращает последние сообщения<br>
<br>
GET_MODE<br>
(S) Возвращает строку режимов канала<br>
<br>
SET_MODE<br>
(SC) Устанавливает один или несколько режимов канала<br>
<br>
KICK &lt;GUID_абонента&gt; [причина]<br>
(SC) Убирает абонента из списка подписчиков с указанием причины<br>
<br>
BAN &lt;GUID_абонента&gt; &lt;срок&gt; [причина]<br>
(SC) Добавляет абонента в "черный список" на заданный срок в указанием причины.<br>
<br>
UNBAN &lt;UID_абонента&gt;<br>
(SC) Удаляет абонента из "черного списка".<br>
<br>
GET_BANLIST<br>
(S) Возвращает "черный список" абонентов<br>
<br>
SAY &lt;GUID_абонента&gt; &lt;текст&gt;<br>
(SC) Сообщение на канал от абонента<br>
<br>
RENAME &lt;GUID_абонента&gt; &lt;новое_имя&gt;&lt;br&gt;<br>
(SC) Переименование абонента<br>
<br>
SET_STATE &lt;GUID_абонента&gt; &lt;признак_состояния&gt; [текст состояния]<br>
(SC) Установка состояния абонента<br>
</code></pre>


<h3>Данные:</h3>

<pre><code><br>
TOPIC - тема канала<br>
Содержит текст темы канала<br>
<br>
USERS - список активных подписчиков<br>
Содержит сериализованный список контактов активных подписчиков.<br>
<br>
ABONENTS - список всех подписчиков<br>
Состав данных тот же, что и в USERS<br>
<br>
BANLIST - список абонентов, помещенных в "черный список"<br>
author_guid - GUID автора<br>
abonent_guid - GUID абонента<br>
end_date - дата-время окончания<br>
reason - текст причины<br>
<br>
MODE - режимы канала<br>
содержит строку режимов канала<br>
<br>
STATE - состояние абонента<br>
содержит признак состояния и текст состояния вида:<br>
&lt;GUID_абонента&gt; &lt;признак_состояния&gt; [текст состояния]<br>
Признаки состояния:<br>
ON - онлайн<br>
OFF - оффлайн<br>
AFK - онлайн, недоступен<br>
BUSY - онлайн, занят (не беспокоить)<br>
Возможны и другие варианты признака состояния.<br>
</code></pre>